name: Unmocked Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Add permissions block
permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  NODE_VERSION: '18.x'
  RESOURCE_GROUP: CPEN321RSRCGROUP
  PR_NUMBER: ${{ github.event.pull_request.number || 'main' }}

jobs:
  setup-mongodb:
    runs-on: ubuntu-latest
    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Verify Azure Connection
      run: |
        echo "Verifying Azure connection..."
        if ! az account show &> /dev/null; then
          echo "::error::Azure login failed - could not verify account"
          exit 1
        fi
        echo "Azure connection verified successfully"
        az account show --query name -o tsv

    - name: Deploy MongoDB to Azure Container Apps
      run: |
        # Check Azure CLI version
        az --version
        
        # First, check if the resource group exists
        if ! az group show --name ${{ env.RESOURCE_GROUP }} &> /dev/null; then
          echo "Creating resource group ${{ env.RESOURCE_GROUP }}..."
          az group create \
            --name ${{ env.RESOURCE_GROUP }} \
            --location eastus
        else
          echo "Resource group ${{ env.RESOURCE_GROUP }} already exists"
        fi
        
        # Next, check if the environment exists
        ENV_NAME="biteswipe-env"
        if ! az containerapp env show --resource-group ${{ env.RESOURCE_GROUP }} --name "$ENV_NAME" &> /dev/null; then
          echo "Creating Container App environment $ENV_NAME..."
          az containerapp env create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name "$ENV_NAME" \
            --location eastus
        else
          echo "Container App environment $ENV_NAME already exists"
        fi
        
        # Now create the container app with the environment
        echo "Creating MongoDB container app..."
        az containerapp create \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name biteswipe-mongodb-test-pr${{ env.PR_NUMBER }} \
          --environment "$ENV_NAME" \
          --image mongo:latest \
          --env-vars MONGO_INITDB_ROOT_USERNAME=test MONGO_INITDB_ROOT_PASSWORD=test MONGO_INITDB_DATABASE=biteswipe "MONGOD_ARGS=--bind_ip_all" \
          --target-port 27017 \
          --ingress external \
          --min-replicas 1 \
          --max-replicas 1 \
          --cpu 0.5 \
          --memory 1.0Gi \
          --query properties.configuration.ingress.fqdn
          
        # Wait for the MongoDB container to be ready
        echo "Waiting for MongoDB container to be ready..."
        sleep 30
      # Azure login is already done at the beginning of the job

    - name: Set MongoDB connection string
      run: |
        # Get the FQDN from the container app
        MONGO_FQDN=$(az containerapp show \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name biteswipe-mongodb-test-pr${{ env.PR_NUMBER }} \
          --query properties.configuration.ingress.fqdn -o tsv)
          
        echo "MongoDB FQDN: $MONGO_FQDN"
        
        # Set the MongoDB connection string for later steps
        # Now including authSource parameter since unmocked_setup.ts has been fixed to handle it
        MONGODB_URI="mongodb://test:test@$MONGO_FQDN:27017/biteswipe?authSource=admin"
        echo "Setting MongoDB connection string: ${MONGODB_URI//:test@/:***@}"
        echo "MONGODB_URI=$MONGODB_URI" >> $GITHUB_ENV
        echo "DB_URI=$MONGODB_URI" >> $GITHUB_ENV
        echo "MONGO_FQDN=$MONGO_FQDN" >> $GITHUB_ENV
        
        # Test the MongoDB connection
        echo "Testing MongoDB connection..."
        echo "Note: Connection will be tested during the test run"
        
        # Verify the environment variables were set
        echo "Verifying environment variables:"
        echo "MONGODB_URI=${MONGODB_URI//:test@/:***@}"
        echo "DB_URI=${MONGODB_URI//:test@/:***@}"

  test:
    needs: setup-mongodb
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Install dependencies
      working-directory: ./backend
      run: |
        echo "Installing dependencies..."
        npm ci
        if [ $? -ne 0 ]; then
          echo "npm ci failed"
          exit 1
        fi

    - name: Azure Login for Firebase Credentials
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Download Firebase Credentials
      working-directory: ${{ github.workspace }}
      run: |
        # Function to download with retries
        download_with_retry() {
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts to download Firebase credentials..."
            
            # Create directory if it doesn't exist
            mkdir -p backend

            # Try to download using Azure CLI with key authentication
            if az storage blob download \
              --account-name productionstorageaccoun2 \
              --container-name production-container \
              --name biteswipe-132f1-firebase-adminsdk-fbsvc-76c5bb6fe5.json \
              --file backend/biteswipe-132f1-firebase-adminsdk-fbsvc-76c5bb6fe5.json \
              --auth-mode key 2>/dev/null; then
              # Verify the file exists and is not empty
              if [ -s backend/biteswipe-132f1-firebase-adminsdk-fbsvc-76c5bb6fe5.json ]; then
                echo "Download successful and file is valid!"
                return 0
              else
                echo "Download succeeded but file is empty or missing!"
                rm -f backend/biteswipe-132f1-firebase-adminsdk-fbsvc-76c5bb6fe5.json
                return 1
              fi
            fi
            
            echo "Download failed. Waiting 5 seconds before retry..."
            sleep 5
            attempt=$((attempt + 1))
          done
          echo "Failed to download after $max_attempts attempts"
          return 1
        }

        # Try to download with retries
        if download_with_retry; then
          # Set proper permissions
          chmod 600 backend/biteswipe-132f1-firebase-adminsdk-fbsvc-76c5bb6fe5.json
          echo "Firebase credentials downloaded and secured successfully"
        else
          echo "Failed to download Firebase credentials after all retries"
          exit 1
        fi

    - name: Create .env file
      working-directory: ./backend
      run: |
        cat > .env << EOF
        PORT=3000
        # Now including authSource parameter since unmocked_setup.ts has been fixed to handle it
        DB_URI=mongodb://test:test@${{ env.MONGO_FQDN }}:27017/biteswipe?authSource=admin
        NODE_ENV=test
        GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}
        FIREBASE_CREDENTIALS_JSON_PATHNAME=${{ github.workspace }}/backend/biteswipe-132f1-firebase-adminsdk-fbsvc-76c5bb6fe5.json
        EOF
        cat .env
      
    - name: Run unmocked tests
      working-directory: ./backend
      run: |
        echo "Running unmocked tests with coverage..."
        npm run test:coverage:unmocked

  # cleanup:
  #   needs: test
  #   runs-on: ubuntu-latest
  #   if: always()
  #   steps:
  #   - name: Azure Login
  #     uses: azure/login@v1
  #     with:
  #       creds: ${{ secrets.AZURE_CREDENTIALS }}

  #   - name: Delete MongoDB Container App
  #     run: |
  #       echo "Cleaning up MongoDB Container App..."
  #       # Check if the container app exists before trying to delete it
  #       if az containerapp show --resource-group ${{ env.RESOURCE_GROUP }} --name biteswipe-mongodb-test-pr${{ env.PR_NUMBER }} &> /dev/null; then
  #         echo "Deleting container app biteswipe-mongodb-test-pr${{ env.PR_NUMBER }}..."
  #         az containerapp delete \
  #           --resource-group ${{ env.RESOURCE_GROUP }} \
  #           --name biteswipe-mongodb-test-pr${{ env.PR_NUMBER }} \
  #           --yes
  #       else
  #         echo "Container app biteswipe-mongodb-test-pr${{ env.PR_NUMBER }} doesn't exist or was already deleted"
  #       fi
        
  #       # Note: We're not deleting the resource group or environment as they may be shared
  #       # between different workflow runs
  #     # Azure login is already done at the beginning of the job